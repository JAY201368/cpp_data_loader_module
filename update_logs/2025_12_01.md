## 2025-12-01 更新记录

### 1. `CompressedMove` 的调用链

`CompressedMove` 的使用路径：

```text
Compressed（定义在行 1628）
  -> binpack 命名空间的 `unpackEntry`
  -> binpack 命名空间的 `CompressedTrainingDataEntryParallelReader`
  -> `BinpackSfenInputParallelStream`（位于 `data_stream.h`）
  -> `open_sfen_input_file_parallel`
       - 接受两种输入文件格式：`bin` 和 `binpack`
       - 其中 `binpack` 格式的输入流强依赖 `Compressed`
  -> `data_loader.c` 中的 `stream` 类
  -> 在 `extern "C"` 部分暴露给 Python 使用
```

- **`.bin` 格式**：老格式，固定 **40 字节/局面**，实现简单、兼容性好，但体积较大。  
- **`.binpack` 格式**：新格式，设计为 **高压缩 + 高吞吐量**，有较复杂的打包/解包逻辑和专门的 reader，并支持多线程读取。

---

### 2. `Move -> CompressedMove`

**`Move` 内容（大小 4 字节）：**

- `Square from`：内部只有一个 `std::uint8_t m_id` → **1 字节**
- `Square to`：同上 → **1 字节**
- `MoveType type`：`enum struct MoveType : std::uint8_t` → **1 字节**
- `Piece padding`：内部也是 `std::uint8_t m_id` → **1 字节**

**压缩为 `CompressedMove` 的位布局（16 bit）：**

- **最高 2 位**：`MoveType type`
- **中间 7 位**：`Square from`
- **最低 7 位**：`Square to`

记 `ordinal()` 为把枚举/格子转为整数：

- `typeBits = ordinal(move.type) << 14`
- `fromBits = ordinal(move.from) << 7`
- `toBits   = ordinal(move.to)`

最后按位或得到：

```text
m_packed = typeBits | fromBits | toBits
```

---

### 3. 行 1964：`CompressedReverseMove`

- 新的 `CompressedReverseMove` 设计中，**删除了 `oldCastlingRights` 字段**，不再添加其它额外内容。  
- 原来用于存 `oldCastlingRights` 的那几位现在被视为 **无效位（reserved/unused）**。

---

### 4. 行 2055：`PackedReverseMove`（`uint32_t m_packed` 布局）

原始布局（使用 27 个最低位）：

- **[26..21]**：`from`（6 bit）
- **[20..15]**：`to`（6 bit）
- **[14..11]**：`capturedPiece`（4 bit）
- **[10..7]**：`oldCastlingRights`（4 bit）
- **[6..4]**：`promotedPieceType`（3 bit）
- **[3]**：`hasEpSquare`（1 bit）
- **[2..0]**：`oldEpSquare.file`（3 bit）

现布局调整为（仍然使用 27 个最低位）：

- **[21..15]**：`from`（7 bit）
- **[14..8]**：`to`（7 bit）
- **[7..4]**：`capturedPiece`（4 bit）
- **[3]**：`hasEpSquare`（1 bit）
- **[2..0]**：`oldEpSquare.file`（3 bit）

说明：

- `from` / `to` 现在都使用 **7 bit**，与新的 `Square` 编码（3 bit file + 4 bit rank = 7 bit）对齐。
- `oldCastlingRights` 和 `promotedPieceType` 从打包格式中移除（国际象棋相关逻辑被裁剪）。

---

### 5. TODO / 后续计划

- 当前仍然保留了 `EpSquare`（`oldEpSquare` 相关位），它对应的是**吃过路兵（en passant）** 的目标格。  
- 对于斗兽棋规则，这一机制实际上是多余的，后续考虑**彻底移除相关字段和位编码**，以进一步简化格式。
